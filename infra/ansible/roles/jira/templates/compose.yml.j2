services:
  postgres:
    image: {{ postgres_image }}
    container_name: {{ postgres_container_name }}
    restart: unless-stopped
    environment:
      POSTGRES_DB: {{ jira_db_name }}
      POSTGRES_USER: {{ jira_db_user }}
      POSTGRES_PASSWORD: {{ jira_db_password }}
      TZ: "{{ ansible_facts['timezone'] | default('UTC') }}"
    volumes:
      - {{ jira_data_dir }}/postgres:/var/lib/postgresql/data
    networks: [jira_net]
    # ресурсы (работают в docker compose без Swarm)
    cpus: "0.5"
    mem_limit: "1g"
    mem_reservation: "512m"
    ulimits:
      nofile:
        soft: 4096
        hard: 8192
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U {{ jira_db_user }} -d {{ jira_db_name }} -h 127.0.0.1 || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10

  jira:
    image: {{ jira_image }}
    container_name: {{ jira_container_name }}
    depends_on: [postgres]
    restart: unless-stopped
    environment:
      JVM_MINIMUM_MEMORY: {{ jira_jvm_min }}
      JVM_MAXIMUM_MEMORY: {{ jira_jvm_max }}
      TZ: "{{ ansible_facts['timezone'] | default('UTC') }}"
      ATL_JDBC_URL: "jdbc:postgresql://postgres:5432/{{ jira_db_name }}"
      ATL_JDBC_USER: "{{ jira_db_user }}"
      ATL_JDBC_PASSWORD: "{{ jira_db_password }}"
{% if jira_enable_proxy %}
      ATL_PROXY_NAME: "{{ jira_proxy_name }}"
      ATL_PROXY_PORT: "443"
      ATL_TOMCAT_SCHEME: "https"
{% endif %}
    volumes:
      - {{ jira_data_dir }}/data:/var/atlassian/application-data/jira
    ports:
      - "127.0.0.1:{{ jira_http_port }}:8080"
    networks: [jira_net]
    # ресурсы
    cpus: "1.5"
    mem_limit: "3g"
    mem_reservation: "2g"
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    stop_grace_period: 60s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"

networks:
  jira_net: {}